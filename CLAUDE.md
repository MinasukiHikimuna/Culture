Remember to run ruff on all new code and fix errors. Fix them properly instead of suppressing.

When refactoring larger functions into shorter ones, place helper functions under the public function in a chronological order as if telling a story.
